这篇教程演示了怎样使用地理编码API连接你自己定义的地理空间数据、Tilequery API和Mapbox的全球地址和位置数据，以便为你的用户带来一种完善的自定义反向搜索体验。

在这篇教程中，你会创建一个展示位于搜索点一公里内的所有卖食物的店铺的web应用程序。你将会使用**Mapbox GL JS**来制作用户界面，使用**Mapbox Geocoding API** （以**Mapbox GL JS Geocoder 插件**的形式）来设置一个搜索点，以及用**Tilequery API**来查找搜索点一公里以内的店铺。

使用这个app的人可以基于位置进行搜索，然后根据搜索结果来确定该地区是否是个_食物荒漠_。[食物荒漠](https://en.wikipedia.org/wiki/Food_desert)是指这样一种市区，至少有超过33%的人口居住在距离超市或者食品杂货店一英里外的地方（对于农村地区，这个距离是超过十英里）。居住在食物荒漠的人很难找得到食物。识别食物沙漠是解决这个问题的第一步。

{{
  <DemoIframe src="/help/demos/tilequery-healthy-food-finder/index.html" />
}}

## 开始

为了完成这篇教程，你需要：

- **A Mapbox access token.**你的[账户页面](https://account.mapbox.com/)的Mapbox访问令牌。

- **Mapbox GL JS.**[Mapbox GL JS](https://www.mapbox.cn/mapbox-gl-js/overview/)是用来创建web地图的JavaScript API库。

- **文本编辑器.**使用你选择的文本编辑器来编写HTML, CSS, 和JavaScript。

- **数据.**原始的文件已经通过移除和这篇教程无关的列的方式做了简化。

  {{
  <Button href="/help/demos/tilequery-healthy-food-finder/food_stores.csv" passthroughProps={{ download: "food_stores.csv" }} >
      <Icon name='arrow-down' inline={true} /> Download CSV
  </Button>
  }}

## 上传数据作为tileset

[tileset](https://docs.mapbox.com/help/glossary/tileset/)是被分解为方形均匀网格的栅格或者矢量数据集。tileset可以被高度缓存和快速载入，并且能使Mapbox地图快速加载。在这个步骤中，你将把食品店的地址作为新的tileset上传到Mapbox，以便于在接下来的步骤中使用。

1. 登陆[Mapbox工作室](https://studio.mapbox.com/)然后导航到[tileset页面](https://studio.mapbox.com/tilesets/)。
2. 点击**新的tileset**按钮。
3. 点击**选择文件**按钮，然后导航到你保存 `food_stores.csv`文件的位置。
4. 选择 `food_stores.csv`，然后点击**确定**。
5. 上传成功后，上传结果会出现在tileset页面的自定义tileset列表的顶部。
6. 点击新的tileset旁边的**菜单**按钮，找到_tileset ID_，这是tileset的唯一标志符。你需要在后面的步骤中使用它，所以请记住你是在哪里找到它的!

## 创建一幅地图

接下来，你将用[Mapbox GL JS](https://docs.mapbox.com/mapbox-gl-js/api/)创建一幅地图。

打开文本编辑器并创建一个名为`index.html`的新文件。通过将以下代码粘贴到文本编辑器中来设置HTML文件。这些代码负责创建页面结构，而且还在页面的`<head>`中导入了Mapbox GL JS和jQuery。 Mapbox GL JS JavaScript和CSS文件能够让你使用Mapbox GL JS的功能和样式，而jQuery允许你使用[Ajax](https://api.jquery.com/jquery.ajax/) 来解析Tilequery API的调用。

在页面的`<body>`中有一个ID为`map`的`<div>`元素。 这个`<div>`将是地图在页面上显示的容器。

```html
<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Healthy food finder</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <!-- Import Mapbox GL JS -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/{{constants.VERSION_MAPBOXGLJS}}/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/{{constants.VERSION_MAPBOXGLJS}}/mapbox-gl.css' rel='stylesheet' />
  <!-- Import jQuery -->
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>

  <div id='map'></div>
  <script>
    mapboxgl.accessToken = '{{ <UserAccessToken /> }}'; // set the access token

    var map = new mapboxgl.Map({
      container: 'map', // The container ID
      style: 'mapbox://styles/mapbox/light-v10', // The map style to use
      center: [-105.0178157, 39.737925], // Starting position [lng, lat]
      zoom: 12 // Starting zoom level
    });
  </script>

</body>

</html>
```



  这段Mapbox GL JS代码设置地图的样式，提供居中的坐标，并设置缩放级别。

  保存更改。 在浏览器中打开HTML文件以查看渲染完成的地图，该地图以丹佛市为中心。

  {{
  <AppropriateImage imageId="tilequeryFoodDesertBaseMap" alt="Screenshot of the map that is generated by following the instructions in this step." />
  }}

## 添加地理编码器

下一步是使用[Mapbox GL JS Geocoder插件](https://github.com/mapbox/mapbox-gl-geocoder)将地理编码器添加到地图中。 此插件允许你在Mapbox GL JS的上下文中使用[Mapbox Geocoding API](https://docs.mapbox.com/api/search/#geocoding)。

要将地理编码器添加到地图中，首先将地理编码器插件的JavaScript和CSS链接添加到HTML文件的头部：

```javascript
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/{{constants.VERSION_GLJS_GEOCODER_PLUGIN}}/mapbox-gl-geocoder.min.js'></script><link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/{{constants.VERSION_GLJS_GEOCODER_PLUGIN}}/mapbox-gl-geocoder.css' type='text/css' />
```



添加这些链接后，你就可以在应用中使用地理编码器插件。 接下来，在HTML文件中的`</ script>`结束标记上方添加以下代码。

```javascript
map.on('load', function() {
  var geocoder = new MapboxGeocoder({ // 初始化地理编码器
    accessToken: mapboxgl.accessToken, // 设置token
    mapboxgl: mapboxgl, // 设置mapbox-gl实例
    zoom: 13, // 为地理编码结果设置缩放级别
    placeholder: "Enter an address or place name", //占位符将会显示在搜索框中
    bbox: [-105.116, 39.679, -104.898, 39.837] // 设置范围框
  });
  // 把地理编码器添加到地图中
  map.addControl(geocoder, 'top-left'); // Add the search box to the top left
});
```

这段代码中的`bbox`参数设置_bounding box_，这意味着地理编码器不会返回指定区域之外的任何结果。 这个边界框的坐标大致描述了丹佛市的范围。 在[Geocoding API文档](https://docs.mapbox.com/api/search/#forward-geocoding)中了解有关`bbox`参数的更多信息。

保存更改。 在浏览器中刷新页面，你将看到带有自定义文本的地理编码器搜索框已经被添加到地图中。 在搜索框中输入关键词并选择搜索结果时，地图将飞到该位置。

{{
<AppropriateImage imageId="tilequeryFoodDesertAddGeocoder" alt="Screenshot showing a map with a functional geocoder in the upper left corner." />
}}

## 在地图上添加一个标记

现在你已经完成了这样一个web应用程序，当用户在地理编码器中输入一个位置时，它会飞到目标位置。

将以下代码粘贴到文件中，位于`map.addControl（geocoder，'top-left'）下面;`：

```javascript
var marker = new mapboxgl.Marker({'color': '#008000'}) // 创建一个新的绿色标记

geocoder.on('result', function(data) { // 当地理编码器返回结果时
  var point = data.result.center; // 取得结果坐标

    marker.setLngLat(point).addTo(map); // 把标记添加到地图上坐标结果所在的位置

});
```

这个代码段在返回结果后初始化一个新的标记，然后将其添加到搜索结果坐标在地图上的对应位置。 在[Mapbox GL JS文档](https://docs.mapbox.com/mapbox-gl-js/api/#marker)中了解有关标记的更多信息。

保存更改。 在浏览器中刷新页面，然后在搜索框中输入位置。 选定搜索结果后，地图将飞到该位置并在此处添加一个绿色标记。

## 添加Tilequery API

在最后一步中，你创建了一个名为`point`的变量，该变量是用户对Geocoding API请求返回的坐标。 在此步骤中，你将在调用[Tilequery API](https://docs.mapbox.com/api/maps/#tilequery)时使用此变量。

### 格式化Tilequery API请求

[Mapbox Tilequery API](https://docs.mapbox.com/api/maps/#tilequery)允许你根据给定的纬度和经度从矢量tileset中检索有关特定要素的数据。

Tilequery请求需要两个参数：被查询的tileset的`tileset_id`，以及查询点的`{lon，lat}`坐标。 Tilequery API接受一个可选的`radius`参数，该参数代表距搜索点的距离（以米为单位），用于搜索要素。 它还接受`limit`参数，以便你可以指定查询可以返回的最大结果数。

Tilequery API的调用案例，其中半径为1,000米，结果数量限制为10，如下所示：

```javascript
https://api.mapbox.com/v4/mapbox.mapbox-streets-v8/tilequery/-105.01109,39.75953.json?radius=1000&limit=10&access_token={{ <UserAccessToken /> }}
```

Tilequery API请求返回一个[GeoJSON`FeatureCollection`](https://tools.ietf.org/html/rfc7946#section-3.3)，包含`radius`参数限定的距离内由`{lon}，{lat}`描述的地理点或其附近的要素。

### 设置Tilequery API调用

在前面编写的`geocoder.on（'result'）`方法中，你将创建另外三个变量，使用它们来构造Tilequery API请求，然后使用Ajax进行Tilequery API调用。

现在，你要为Tilequery API将查询的tileset创建变量，需要搜索的半径范围以及要返回的最大结果数。 返回[Tilesets页面](https://studio.mapbox.com/tilesets/)并找到你创建的tileset的_tileset ID_。 在你之前声明的`point`变量之后，添加以下附加变量：

```javascript
var tileset = 'examples.dl46ljcs'; // 用你创建的tileset id来替换这个
var radius = 1609; // 一英里大致等于1609米
var limit = 50; // 返回结果的最大数量
```

接下来，使用这些新变量为Tilequery API请求创建一个新的变量。

```javascript
var query = 'https://api.mapbox.com/v4/' + tileset + '/tilequery/' + point[0] + ',' + point[1] + '.json?radius=' + radius + '&limit= ' + limit + ' &access_token=' + mapboxgl.accessToken;
```

接下来，你将使用Ajax进行Tilequery API调用。 在结束大括号之前，在`geocoder.on（'result'）`调用中添加以下代码。 在下一步中，你将为半径区域中的每个商店添加一个圆圈，但是现在你可以使用`console.log（）`查看结果。

```javascript
$.ajax({
  method: 'GET',
  url: query,
}).done(function(data) {
  console.log(data);
  // 接下来的代码会写在这里
})
```

保存更改并打开开发人员工具。 在浏览器中刷新页面，然后在搜索框中输入位置。 选定其中一个结果，对Tilequery API的调用结果将打印到控制台。

{{
<AppropriateImage imageId="tilequeryFoodDesertLogResults" alt="Screenshot showing a map. The browser's developer tools are open with the GeoJSON FeatureCollection results displayed." />
}}

## 显示商店的位置

在最后一步中，你将设置Tilequery API调用，该调用使用地理编码API的请求结果坐标作为查询点。 现在你的查询请求返回了商店的位置，你将使用Mapbox GL JS将每个商店位置的可视化表示添加到地图中。

在`map.on（'load'）`函数的结束大括号之前，把以下代码添加到JavaScript的末尾。

```javascript
map.addSource('tilequery', { // 给地图样式添加一个新的源
  https://docs.mapbox.com/mapbox-gl-js/api/#map#addsource
  type: "geojson",
  data: {
    "type": "FeatureCollection",
    "features": []
  }
});

map.addLayer({ // 给地图样式添加一个新的层: https://docs.mapbox.com/mapbox-gl-js/api/#map#addlayer
  id: "tilequery-points",
  type: "circle",
  source: "tilequery", // Set the layer source
  paint: {
    "circle-stroke-color": "white",
    "circle-stroke-width": { // 为每个圆设置填充颜色: https://docs.mapbox.com/mapbox-gl-js/style-spec/#paint-circle-circle-stroke-width
      stops: [
        [0, 0.1],
        [18, 3]
      ],
      base: 5
    },
    "circle-radius": { // 为每个圆设置各个级别下的半径同时也确定了尺寸: https://docs.mapbox.com/mapbox-gl-js/style-spec/#paint-circle-circle-radius
      stops: [
        [12, 5],
        [22, 180]
      ],
      base: 5
    },
    "circle-color": [ // 指定每个圆的颜色
      'match', // 使用'match' 表达式: https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match
      ['get', 'STORE_TYPE'], // 使用 'STORE_TYPE' 属性
      'Convenience Store', '#FF8C00',
      'Convenience Store With Gas', '#FF8C00',
      'Pharmacy', '#FF8C00',
      'Specialty Food Store', '#9ACD32',
      'Small Grocery Store', '#008000',
      'Supercenter', '#008000',
      'Superette', '#008000',
      'Supermarket', '#008000',
      'Warehouse Club Store', '#008000',
      '#FF0000' // any other store type
    ]
  }
});
```

这段代码使用Mapbox GL JS`match`表达式根据`STORE_TYPE`属性设置每个圆的颜色：

- 顾客可能会找到新鲜农产品和其他健康食品的任何规模的杂货店，设置为{{<ColorSwatch color =“＃008000"/>}}。
- 特色食品商店，可能有也可能没有新鲜农产品，设置为{{<ColorSwatch color =“＃9ACD32"/>}}。
- 经常有食物但很少有新鲜食物的便利店被设置为{{<ColorSwatch color =“＃FF8C00"/>}}。
- 其他任何`STORE_TYPE`的商店设置为{{<ColorSwatch color =“＃FF0000"/>}}。

在[Mapbox样式规范](https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions)中了解有关表达式以及如何使用它们的更多信息。

现在你已经设置了`tilequery`源并添加了点数据的可视化规则，将在最后一步创建的Ajax调用中引用它。 替换`console.log（resp）;`所以这个函数现在是：

```javascript
$.ajax({ // 调用API
  method: 'GET',
  url: query,
}).done(function(data) { // 使用返回的数据设置“tilequery”源
  map.getSource('tilequery').setData(data);
})
```

保存更改并在浏览器中刷新页面。 搜索位置时，你将看到根据`match`表达式着色的商店位置出现在地图上。

{{
<AppropriateImage imageId="tilequeryFoodDesertStoreLocations" alt="Screenshot showing the colored circles that populated on the map after a successful Tilequery API call." />
}}

## 为每个商店添加弹出窗口

最后一步是为每个商店添加弹出窗口，列出商店的名称，类型，地址和距查询点的距离。 Mapbox GL JS提供了一个[弹出组件](https://docs.mapbox.com/mapbox-gl-js/api/#popup)，允许你根据需求自定义弹出窗口。

在`map.on（'load'）`函数的结束大括号之前，将以下代码添加到JavaScript文件的末尾：

```javascript
var popup = new mapboxgl.Popup; // 初始化弹出窗口

map.on('mouseenter', 'tilequery-points', function(e) {
  map.getCanvas().style.cursor = 'pointer'; // 当光标进入一个要素时，将其设置为指针

  var title = '<h3>' + e.features[0].properties.STORE_NAME + '</h3>'; // 设置商店名字
  var storeType = '<h4>' + e.features[0].properties.STORE_TYPE + '</h4>'; // 设置商店类型
  var storeAddress = '<p>' + e.features[0].properties.ADDRESS_LINE1 + '</p>'; // 设置商店地址
  var obj = JSON.parse(e.features[0].properties.tilequery); // Get the feature's tilequery object (https://docs.mapbox.com/api/maps/#response-retrieve-features-from-vector-tiles)
  var distance = '<p>' + (obj.distance / 1609.344).toFixed(2) + ' mi. from location' + '</p>'; // 获取距离属性，将其转换为英里，并在小数点后两位截断

  var lon = e.features[0].properties.longitude;
  var lat = e.features[0].properties.latitude;
  var coordinates = new mapboxgl.LngLat(lon, lat); // 创建一个新的经纬度对象 (https://docs.mapbox.com/mapbox-gl-js/api/#lnglatlike)
  var content = title + storeType + storeAddress + distance; // 所有的html元素

  popup.setLngLat(coordinates) // 在给定的坐标上设置弹出窗口
    .setHTML(content) // 将弹出内容设置为你创建的HTML元素
    .addTo(map); // 将弹出框添加到地图中
})

map.on('mouseleave', 'tilequery-points', function() {
  map.getCanvas().style.cursor = ''; // 当光标离开该点时重置光标
  popup.remove(); // 当光标离开该点时移除弹出窗口
});
```

保存更改并在浏览器中刷新页面。 当商店位置出现在地图上时，鼠标悬停在每个位置时会显示一个弹出窗口。

{{
<AppropriateImage imageId="tilequeryFoodDesertPopup" alt="Screenshot showing the map with a popup displayed over one store location." />
}}

## 最终产品

你创建了一个使用Tilequery API来增强Mapbox地理编码器，以识别丹佛市的潜在食物沙漠的应用程序。

{{
  <DemoIframe src="/help/demos/tilequery-healthy-food-finder/index.html" />
}}

最终的HTML文件如下所示：

```html
<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>Healthy food finder</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/{{constants.VERSION_MAPBOXGLJS}}/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/{{constants.VERSION_MAPBOXGLJS}}/mapbox-gl.css' rel='stylesheet' />
  <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/{{constants.VERSION_GLJS_GEOCODER_PLUGIN}}/mapbox-gl-geocoder.min.js'></script>
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/{{constants.VERSION_GLJS_GEOCODER_PLUGIN}}/mapbox-gl-geocoder.css' type='text/css' />
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>

<body>

  <div id='map'></div>
  <script>
    mapboxgl.accessToken = '{{ <UserAccessToken /> }}';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      center: [-105.0178157, 39.737925],
      zoom: 12
    });

    map.on('load', function() {
      var geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        zoom: 13,
        placeholder: "Enter an address or place name",
        bbox: [-105.116, 39.679, -104.898, 39.837]
      });

      map.addControl(geocoder, 'top-left');

      var marker = new mapboxgl.Marker({'color': '#008000'})

      geocoder.on('result', function(data) {

        var point = data.result.center;
        var tileset = 'examples.dl46ljcs';
        var radius = 1609;
        var limit = 50;
        var query = 'https://api.mapbox.com/v4/' + tileset + '/tilequery/' + point[0] + ',' + point[1] + '.json?radius=' + radius + '&limit= ' + limit + ' &access_token=' + mapboxgl.accessToken;

        marker.setLngLat(point).addTo(map);

        $.ajax({
          method: 'GET',
          url: query,
        }).done(function(data) {
          map.getSource('tilequery').setData(data);
        })
      });

      map.addSource('tilequery', {
        type: "geojson",
        data: {
          "type": "FeatureCollection",
          "features": []
        }
      });

      map.addLayer({
        id: "tilequery-points",
        type: "circle",
        source: "tilequery",
        paint: {
          "circle-stroke-color": "white",
          "circle-stroke-width": {
            stops: [
              [0, 0.1],
              [18, 3]
            ],
            base: 5
          },
          "circle-radius": {
            stops: [
              [12, 5],
              [22, 180]
            ],
            base: 5
          },
          "circle-color": [
            'match',
            ['get', 'STORE_TYPE'],
            'Convenience Store', '#FF8C00',
            'Convenience Store With Gas', '#FF8C00',
            'Pharmacy', '#FF8C00',
            'Specialty Food Store', '#9ACD32',
            'Small Grocery Store', '#008000',
            'Supercenter', '#008000',
            'Superette', '#008000',
            'Supermarket', '#008000',
            'Warehouse Club Store', '#008000',
            '#FF0000' // any other store type
          ]
        }
      });

      var popup = new mapboxgl.Popup;

      map.on('mouseenter', 'tilequery-points', function(e) {
        map.getCanvas().style.cursor = 'pointer';

        var title = '<h3>' + e.features[0].properties.STORE_NAME + '</h3>';
        var storeType = '<h4>' + e.features[0].properties.STORE_TYPE + '</h4>';
        var storeAddress = '<p>' + e.features[0].properties.ADDRESS_LINE1 + '</p>';
        var obj = JSON.parse(e.features[0].properties.tilequery);
        var distance = '<p>' + (obj.distance / 1609.344).toFixed(2) + ' mi. from location' + '</p>';

        var lon = e.features[0].properties.longitude;
        var lat = e.features[0].properties.latitude;
        var coordinates = new mapboxgl.LngLat(lon, lat);
        var content = title + storeType + storeAddress + distance;

        popup.setLngLat(coordinates)
          .setHTML(content)
          .addTo(map);
      })

      map.on('mouseleave', 'tilequery-points', function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
      });

    })
  </script>

</body>

</html>
```

## 接下来的步骤

你可以做很多事情来进一步开发这个应用。你可以:

- 添加另一个具有人口维度数据的自定义tileset，这能让你调查一个没有很多商店的区域是否真正得不到服务，还是因为它人口不够多。(参见 [可视化人口密度](https://docs.mapbox.com/mapbox-gl-js/example/visualize-population-density/)示例。)

- 在Mapbox GL JS中试用表达式，以便根据商店类型进一步自定义商店位置结果。(参见 [数据驱动的风格化圆圈](https://docs.mapbox.com/mapbox-gl-js/example/data-driven-circle-colors/) 示例。)

- 创建一个切换功能，能让你只显示特定商店类型的结果，如“超市”或“提供煤气“的便利店”。 (参见 [通过切换列表过滤符号](https://docs.mapbox.com/mapbox-gl-js/example/filter-markers/) 示例。)

